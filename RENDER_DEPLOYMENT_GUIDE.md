# Render Deployment Guide

This guide will help you deploy all services to Render.

## Services Overview

1. **Gurukul Backend** (Web Service) - Port 3000 - Includes Karma Tracker
2. **EMS Backend** (Web Service) - Port 8000
3. **Gurukul Frontend** (Static Site) - Port 5173
4. **EMS Frontend** (Static Site) - Port 3001
5. **Bucket Consumer** (Background Worker) - Processes PRANA packets

## Quick Start (Using render.yaml)

1. **Connect your GitHub repository to Render:**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New" â†’ "Blueprint"
   - Connect your GitHub repository
   - Select the `render.yaml` file
   - Render will automatically create all services

2. **Set Environment Variables:**
   - After services are created, go to each service's settings
   - Click "Environment" tab
   - Add each variable using "Add Environment Variable" button
   - Copy-paste the KEY and VALUE from the sections below
   - **Note:** Variables marked as "Copy-paste ready" can be used directly. Variables marked as "Set manually" need your actual values.

## Manual Setup (Step by Step)

### 1. Gurukul Backend

**Service Type:** Web Service  
**Environment:** Python 3  
**Build Command:** `pip install -r backend/requirements.txt`  
**Start Command:** `cd backend && uvicorn app.main:app --host 0.0.0.0 --port $PORT`

**Environment Variables (Copy-paste ready):**
```
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080
ENVIRONMENT=production
PYTHON_VERSION=3.11.0
```

**Environment Variables (Set manually after deployment):**
```
DATABASE_URL=postgresql://user:password@host:port/dbname
SECRET_KEY=<auto-generated-by-render-or-set-manually>
MONGODB_URI=mongodb+srv://user:password@cluster.mongodb.net/dbname
REDIS_URL=redis://default:password@host:port
FRONTEND_URL=https://gurukul-frontend.onrender.com
EMS_FRONTEND_URL=https://ems-frontend.onrender.com
```

### 2. EMS Backend

**Service Type:** Web Service  
**Environment:** Python 3  
**Build Command:** `pip install -r "EMS System/requirements.txt"`  
**Start Command:** `cd "EMS System" && uvicorn app.main:app --host 0.0.0.0 --port $PORT`

**Environment Variables (Copy-paste ready):**
```
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080
ENVIRONMENT=production
MAIL_FROM=noreply@schoolmanagement.com
MAIL_PORT=587
MAIL_SERVER=smtp.gmail.com
MAIL_STARTTLS=true
MAIL_SSL_TLS=false
USE_CREDENTIALS=true
PASSWORD_TOKEN_EXPIRE_MINUTES=30
PYTHON_VERSION=3.11.0
```

**Environment Variables (Set manually after deployment):**
```
DATABASE_URL=postgresql://user:password@host:port/dbname
SECRET_KEY=<auto-generated-by-render-or-set-manually>
FRONTEND_URL=https://ems-frontend.onrender.com
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
```

### 3. Bucket Consumer (Background Worker)

**Service Type:** Background Worker  
**Environment:** Python 3  
**Build Command:** `pip install -r backend/requirements.txt`  
**Start Command:** `cd backend && python scripts/start_bucket_consumer.py --backend-url $GURUKUL_BACKEND_URL`

**Environment Variables (Copy-paste ready):**
```
POLL_INTERVAL_SECONDS=5
BATCH_SIZE=10
PYTHON_VERSION=3.11.0
```

**Environment Variables (Set manually after deployment):**
```
GURUKUL_BACKEND_URL=https://gurukul-backend.onrender.com
```

**Note:** Replace `https://gurukul-backend.onrender.com` with your actual Gurukul Backend service URL from Render.

### 4. Gurukul Frontend

**Service Type:** Static Site  
**Build Command:** `cd Frontend && npm install && npm run build`  
**Publish Directory:** `Frontend/dist`

**Environment Variables (Copy-paste ready - Update URLs after backend deployment):**
```
VITE_API_URL=https://gurukul-backend.onrender.com
VITE_EMS_API_URL=https://ems-backend.onrender.com
```

**Note:** Replace the URLs with your actual backend service URLs from Render.

### 5. EMS Frontend

**Service Type:** Static Site  
**Build Command:** `cd "EMS System/frontend" && npm install && npm run build`  
**Publish Directory:** `EMS System/frontend/dist`

**Environment Variables (Copy-paste ready - Update URL after backend deployment):**
```
VITE_API_URL=https://ems-backend.onrender.com
```

**Note:** Replace the URL with your actual EMS Backend service URL from Render.

## Database Setup

### PostgreSQL (for both backends)

1. Create a PostgreSQL database in Render
2. Copy the Internal Database URL
3. Set `DATABASE_URL` in both backend services

### MongoDB (for Karma Tracker)

1. Create a MongoDB Atlas account (free tier available)
2. Create a cluster and database
3. Get the connection string
4. Set `MONGODB_URI` in Gurukul Backend

### Redis (optional, for caching)

1. Create a Redis instance in Render (or use Redis Cloud)
2. Get the connection URL
3. Set `REDIS_URL` in Gurukul Backend

## Email Configuration (for EMS Backend)

1. **Gmail Setup:**
   - Enable 2-Factor Authentication
   - Generate an App Password
   - Use the app password in `MAIL_PASSWORD`

2. **Other SMTP Providers:**
   - Update `MAIL_SERVER`, `MAIL_PORT`, `MAIL_STARTTLS`, `MAIL_SSL_TLS` accordingly

## Service URLs

After deployment, your services will be available at:
- Gurukul Backend: `https://gurukul-backend.onrender.com`
- EMS Backend: `https://ems-backend.onrender.com`
- Gurukul Frontend: `https://gurukul-frontend.onrender.com`
- EMS Frontend: `https://ems-frontend.onrender.com`

## CORS Configuration

Update CORS settings in both backends to include your Render frontend URLs:

**Gurukul Backend (`backend/app/main.py`):**
```python
allow_origins=[
    "https://gurukul-frontend.onrender.com",
    "https://ems-frontend.onrender.com",
    # ... other origins
]
```

**EMS Backend (`EMS System/app/main.py`):**
```python
allow_origins=[
    "https://ems-frontend.onrender.com",
    "https://gurukul-frontend.onrender.com",
    # ... other origins
]
```

## Frontend API Configuration

Update frontend API URLs to use Render service URLs:

**Gurukul Frontend (`Frontend/src/services/api.js` or similar):**
```javascript
const API_BASE_URL = import.meta.env.VITE_API_URL || 'https://gurukul-backend.onrender.com';
```

**EMS Frontend (`EMS System/frontend/src/services/api.js`):**
```javascript
const API_BASE_URL = import.meta.env.VITE_API_URL || 'https://ems-backend.onrender.com';
```

## Troubleshooting

### Build Failures
- Check build logs in Render dashboard
- Ensure all dependencies are in `requirements.txt` or `package.json`
- Verify Python/Node versions match

### Database Connection Issues
- Verify `DATABASE_URL` is correct
- Check if database is accessible from Render
- Ensure database is not paused (free tier pauses after inactivity)

### CORS Errors
- Update CORS origins in backend to include frontend URLs
- Check browser console for specific CORS errors

### Email Not Sending
- Verify SMTP credentials
- Check email service logs
- Ensure `MAIL_USERNAME` and `MAIL_PASSWORD` are correct

### Bucket Consumer Not Working
- Verify `GURUKUL_BACKEND_URL` is set correctly
- Check worker logs in Render dashboard
- Ensure backend is running and accessible

## Cost Estimation

**Free Tier:**
- 2 Web Services (Gurukul Backend, EMS Backend)
- 2 Static Sites (Gurukul Frontend, EMS Frontend)
- 1 Background Worker (Bucket Consumer)

**Note:** Free tier services spin down after 15 minutes of inactivity. Consider upgrading to paid plans for production use.

## Next Steps

1. Set up monitoring and alerts
2. Configure custom domains (if needed)
3. Set up SSL certificates (automatically handled by Render)
4. Configure auto-deploy from GitHub
5. Set up database backups

## Support

For issues specific to Render, check:
- [Render Documentation](https://render.com/docs)
- [Render Community](https://community.render.com)

